name: ü§ñ WhatsApp Bot - Tustus Scraper

on:
  schedule:
    # Run 5 times daily at 8:00, 11:00, 14:00, 17:00, 20:00 UTC
    # Israel time: 10:00, 13:00, 16:00, 19:00, 22:00
    - cron: '0 8,11,14,17,20 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main, master ]
    paths:
      - 'whatsapp_bot.py'
      - 'scheduler.py'
      - 'requirements.txt'

jobs:
  run-bot:
    name: üöÄ Run Tustus Bot
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üêç Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üîß Install system dependencies
      run: |
        sudo apt-get update -q
        sudo apt-get install -y wget gnupg unzip curl
        # Add Google Chrome repository
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update -q
        sudo apt-get install -y google-chrome-stable
        # Clean up
        sudo apt-get autoremove -y
        sudo apt-get clean
        
    - name: üöó Install ChromeDriver
      run: |
        # Get Chrome major version
        CHROME_VERSION=$(google-chrome --version | cut -d " " -f3 | cut -d "." -f1)
        echo "Chrome major version: $CHROME_VERSION"
        
        # Try to get the latest compatible ChromeDriver version
        LATEST_DRIVER_URL="https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_VERSION}"
        echo "Checking URL: $LATEST_DRIVER_URL"
        
        if curl --output /dev/null --silent --head --fail "$LATEST_DRIVER_URL"; then
          CHROMEDRIVER_VERSION=$(curl -s "$LATEST_DRIVER_URL")
          echo "Found ChromeDriver version: $CHROMEDRIVER_VERSION"
        else
          echo "Using default stable ChromeDriver"
          CHROMEDRIVER_VERSION="stable"
        fi
        
        # Download ChromeDriver using Chrome for Testing
        echo "Downloading ChromeDriver ${CHROMEDRIVER_VERSION}..."
        if [ "$CHROMEDRIVER_VERSION" = "stable" ]; then
          DOWNLOAD_URL="https://storage.googleapis.com/chrome-for-testing-public/stable/linux64/chromedriver-linux64.zip"
        else
          DOWNLOAD_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        fi
        
        echo "Download URL: $DOWNLOAD_URL"
        wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"
        
        # Extract and install
        sudo mkdir -p /usr/local/bin/
        sudo unzip -j /tmp/chromedriver.zip "chromedriver-linux64/chromedriver" -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version || echo "ChromeDriver version check failed but installation might still be OK"
        
    - name: üì¶ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        
    - name: üîç Validate environment
      run: |
        echo "Checking required environment variables..."
        if [ -z "${{ secrets.TARGET_URL }}" ]; then echo "‚ùå TARGET_URL not set"; exit 1; fi
        if [ -z "${{ secrets.RESEND_API_KEY }}" ]; then echo "‚ùå RESEND_API_KEY not set"; exit 1; fi
        if [ -z "${{ secrets.TO_EMAIL }}" ]; then echo "‚ùå TO_EMAIL not set"; exit 1; fi
        echo "‚úÖ All required environment variables are set"
        
    - name: ü§ñ Run WhatsApp Bot
      env:
        TARGET_URL: ${{ secrets.TARGET_URL }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        TO_EMAIL: ${{ secrets.TO_EMAIL }}
        EMAIL_SUBJECT: ${{ secrets.EMAIL_SUBJECT }}
        REQUEST_TIMEOUT: ${{ secrets.REQUEST_TIMEOUT }}
      run: |
        echo "üöÄ Starting WhatsApp Bot at $(date)"
        python whatsapp_bot.py
        echo "‚úÖ Bot execution completed at $(date)"
        
    - name: üìä Upload execution logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-execution-logs-${{ github.run_number }}
        path: |
          bot_scheduler.log
          *.log
        retention-days: 7
        
    - name: üìß Notify on failure
      if: failure()
      run: |
        echo "‚ùå Bot execution failed at $(date)"
        echo "Check the logs in the Actions tab for details"
